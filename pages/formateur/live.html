<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Création Live - EduSpace Formateur</title>
    <!-- Tailwind CSS for full design fidelity -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Config to match main.css vars if needed, but Tailwind defaults are close enough for "modern" look -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blue: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        gray: { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 500: '#6b7280', 700: '#374151', 900: '#111827' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="../../css/main.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Overrides */
        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            background: #f9fafb;
            margin-left: 280px;
            /* Offset for fixed sidebar */
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .step-item.active .step-number {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .step-item.completed .step-number {
            background-color: #22c55e;
            color: white;
            border-color: #22c55e;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900">
    <div class="dashboard-layout">
        <div id="sidebar-container"></div>

        <!-- Quiz Modal -->
        <div id="quiz-modal"
            class="fixed inset-0 z-50 bg-gray-900/50 hidden flex items-center justify-center backdrop-blur-sm">
            <div
                class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col m-4 animate-[fadeIn_0.2s_ease-out]">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Éditeur de Quiz</h3>
                        <p class="text-sm text-gray-500" id="quiz-modal-subtitle">Ajoutez des questions pour vérifier
                            les connaissances</p>
                    </div>
                    <button onclick="closeQuizModal()" class="p-2 hover:bg-gray-200 rounded-full transition-colors">
                        <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 custom-scrollbar" id="quiz-questions-list">
                    <!-- Questions will be rendered here -->
                </div>

                <div class="p-6 bg-gray-50 border-t border-gray-100 flex justify-between items-center rounded-b-2xl">
                    <button onclick="addQuestion()"
                        class="flex items-center px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 font-medium hover:bg-gray-50 transition-colors">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Ajouter Question
                    </button>
                    <button onclick="saveQuiz()"
                        class="flex items-center px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg transition-transform hover:-translate-y-0.5">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i> Enregistrer le Quiz
                    </button>
                </div>
            </div>
        </div>

        <main class="main-content">
            <header class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-4">
                    <button onclick="history.back()"
                        class="p-2 hover:bg-white rounded-lg transition-colors border border-transparent hover:border-gray-200 shadow-sm"><i
                            data-lucide="arrow-left" class="text-gray-600"></i></button>
                    <h1 class="text-2xl font-bold text-gray-900">Nouveau Cours Live</h1>
                </div>
            </header>

            <div class="max-w-4xl mx-auto">
                <!-- Step Indicators -->
                <div class="flex justify-between relative mb-12">
                    <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-gray-200 -z-10 -translate-y-1/2"></div>

                    <div class="step-item active flex flex-col items-center gap-2 bg-gray-50 px-4 z-10" id="step-ind-1">
                        <div
                            class="step-number w-10 h-10 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center font-bold text-gray-500 transition-colors">
                            1</div>
                        <span class="text-sm font-bold text-gray-500">Infos</span>
                    </div>
                    <div class="step-item flex flex-col items-center gap-2 bg-gray-50 px-4 z-10" id="step-ind-2">
                        <div
                            class="step-number w-10 h-10 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center font-bold text-gray-500 transition-colors">
                            2</div>
                        <span class="text-sm font-bold text-gray-500">Contenu</span>
                    </div>
                    <div class="step-item flex flex-col items-center gap-2 bg-gray-50 px-4 z-10" id="step-ind-3">
                        <div
                            class="step-number w-10 h-10 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center font-bold text-gray-500 transition-colors">
                            3</div>
                        <span class="text-sm font-bold text-gray-500">Affectation</span>
                    </div>
                </div>

                <form id="course-form" onsubmit="return false;">
                    <!-- Step 1: Info -->
                    <div class="form-section active" id="step-1">
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                            <h2 class="text-xl font-bold mb-6 text-gray-900">Informations Générales</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Titre du cours</label>
                                    <input type="text" id="course-title"
                                        class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                        placeholder="Ex: Algèbre Linéaire">
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Type</label>
                                        <select
                                            class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                                            <option>Scolaire</option>
                                            <option>Universitaire</option>
                                            <option>Formation</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Niveau</label>
                                        <select
                                            class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                                            <option>1ère Année</option>
                                            <option>2ème Année</option>
                                            <option>3ème Année</option>
                                            <option>4ème Année</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end">
                                <button onclick="nextStep(2)"
                                    class="flex items-center px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg transition-transform hover:-translate-y-0.5">
                                    Suivant <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Content (State-Driven) -->
                    <div class="form-section" id="step-2">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">Plan du Cours</h2>
                                <p class="text-gray-500">Structurez votre cours avec des chapitres, leçons et quiz.</p>
                            </div>
                            <button onclick="addNewChapter()"
                                class="flex items-center px-4 py-2 bg-gray-900 hover:bg-gray-800 text-white rounded-xl font-bold shadow-lg transition-transform hover:-translate-y-0.5">
                                <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Nouveau Chapitre
                            </button>
                        </div>

                        <div id="chapters-container" class="space-y-6">
                            <!-- Chapters rendered via JS -->
                        </div>

                        <div class="mt-8 flex justify-between items-center">
                            <button onclick="nextStep(1)"
                                class="px-6 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-xl transition-colors">Retour</button>
                            <button onclick="nextStep(3)"
                                class="flex items-center px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg transition-transform hover:-translate-y-0.5">
                                Suivant <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Assignment & Validation -->
                    <div class="form-section" id="step-3">
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                            <h2 class="text-xl font-bold mb-6 text-gray-900">Affectation & Validation</h2>

                            <div
                                class="bg-blue-50 p-6 rounded-xl border border-blue-100 mb-8 relative overflow-hidden group">
                                <div class="relative z-10">
                                    <h3 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                                        <i data-lucide="info" class="w-5 h-5"></i> Résumé du Cours
                                    </h3>
                                    <p id="summary-text" class="text-blue-800 font-medium text-lg">Chargement...</p>
                                    <div id="summary-details" class="mt-4 flex flex-wrap gap-3">
                                        <!-- Details injected via JS -->
                                    </div>
                                </div>
                                <div
                                    class="absolute right-0 top-0 w-32 h-32 bg-blue-200/50 rounded-full -mr-10 -mt-10 blur-2xl group-hover:bg-blue-300/50 transition-colors">
                                </div>
                            </div>

                            <div class="mb-8">
                                <label class="block text-sm font-bold text-gray-700 mb-3">Affecter à une classe
                                    (Optionnel)</label>
                                <div id="classes-select"
                                    class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                                    <!-- Classes loaded here -->
                                </div>
                            </div>

                            <div class="flex justify-between items-center pt-6 border-t border-gray-100">
                                <button onclick="nextStep(2)"
                                    class="px-6 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-xl transition-colors">Retour</button>
                                <button onclick="finishCreation()"
                                    class="flex items-center px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg shadow-green-900/20 transition-transform hover:-translate-y-0.5">
                                    <i data-lucide="check" class="w-5 h-5 mr-2"></i> Publier le Cours
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../../js/data-manager.js"></script>
    <script src="../../js/components/sidebar-formateur.js"></script>
    <script>
        // --- State Management ---
        let chapters = [
            {
                id: Date.now(),
                title: '',
                pdf: null,
                subChapters: [
                    { id: Date.now() + 1, title: '', pdf: null, quiz: null }
                ]
            }
        ];

        let editingQuizState = { chapterIndex: -1, subIndex: -1, currentQuiz: null };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderChapters();
        });

        // --- Navigation ---
        function nextStep(step) {
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));

            document.getElementById(`step-${step}`).classList.add('active');

            for (let i = 1; i <= step; i++) {
                document.getElementById(`step-ind-${i}`).classList.add('active');
                if (i < step) document.getElementById(`step-ind-${i}`).classList.add('completed');
            }

            if (step === 3) updateSummary();
            lucide.createIcons();
        }

        // --- Render Logic ---
        function renderChapters() {
            const container = document.getElementById('chapters-container');
            container.innerHTML = '';

            chapters.forEach((chap, cIndex) => {
                const chapEl = document.createElement('div');
                chapEl.className = 'bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden transition-all hover:shadow-md animate-[fadeIn_0.3s_ease-out]';

                // Chapter Header
                chapEl.innerHTML = `
                    <div class="p-5 bg-gray-50 border-b border-gray-100 flex flex-wrap items-center gap-4">
                        <div class="w-8 h-8 bg-indigo-600 text-white rounded-lg flex items-center justify-center font-bold shadow-sm text-sm">
                            ${cIndex + 1}
                        </div>
                        <input
                            type="text"
                            value="${chap.title}"
                            onchange="updateChapterTitle(${cIndex}, this.value)"
                            placeholder="Titre du Chapitre"
                            class="flex-1 min-w-[200px] bg-transparent border-none focus:ring-0 text-lg font-bold text-gray-800 placeholder-gray-400 outline-none"
                        />
                        
                        <div class="flex items-center gap-2">
                            ${!chap.pdf ? `
                                <label class="cursor-pointer px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition-all flex items-center gap-2 group">
                                    <i data-lucide="upload" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                                    <span class="hidden sm:inline">PDF</span>
                                    <input type="file" accept="application/pdf" onchange="handleChapterPdf(${cIndex}, this)" class="hidden" />
                                </label>
                            ` : `
                                <div class="flex items-center gap-2 px-3 py-2 bg-green-50 text-green-700 rounded-lg border border-green-100 shadow-sm">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                    <span class="text-sm font-bold truncate max-w-[100px]" title="${chap.pdf}">${chap.pdf}</span>
                                    <button onclick="removeChapterPdf(${cIndex})" class="p-1 hover:bg-green-100 rounded-full transition-colors">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            `}
                            ${chapters.length > 1 ? `
                                <button onclick="removeChapter(${cIndex})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Supprimer le chapitre">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;

                // SubChapters
                const subContainer = document.createElement('div');
                subContainer.className = 'p-5 space-y-3';

                chap.subChapters.forEach((sub, sIndex) => {
                    const subEl = document.createElement('div');
                    subEl.className = 'flex items-center gap-3 p-3 rounded-xl bg-white border border-gray-100 hover:border-indigo-200 hover:shadow-sm transition-all group';
                    subEl.innerHTML = `
                        <div class="w-2 h-2 bg-gray-300 rounded-full group-hover:bg-indigo-400 transition-colors"></div>
                        <input
                            type="text"
                            value="${sub.title}"
                            onchange="updateSubTitle(${cIndex}, ${sIndex}, this.value)"
                            placeholder="Titre de la leçon"
                            class="flex-1 bg-transparent border-none focus:ring-0 text-sm font-medium text-gray-700 placeholder-gray-400 outline-none"
                        />
                        
                        <div class="flex items-center gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                             ${!sub.pdf ? `
                                <label class="cursor-pointer p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-indigo-600 transition-colors" title="Ajouter PDF">
                                    <i data-lucide="file-plus" class="w-4 h-4"></i>
                                    <input type="file" accept="application/pdf" onchange="handleSubPdf(${cIndex}, ${sIndex}, this)" class="hidden" />
                                </label>
                            ` : `
                                <div class="flex items-center gap-1 px-2 py-1 bg-green-50 text-green-700 rounded-lg text-xs font-bold border border-green-100 cursor-help" title="${sub.pdf}">
                                    <span>PDF</span>
                                    <button onclick="removeSubPdf(${cIndex}, ${sIndex})">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            `}
                            
                            <button onclick="openQuizEditor(${cIndex}, ${sIndex})" 
                                class="p-2 rounded-lg transition-colors ${sub.quiz && sub.quiz.questions.length > 0 ? 'text-purple-600 bg-purple-50 ring-1 ring-purple-100' : 'text-gray-400 hover:bg-purple-50 hover:text-purple-600'}"
                                title="Gérer le Quiz">
                                <i data-lucide="file-question" class="w-4 h-4"></i>
                            </button>

                            <button onclick="removeSubChapter(${cIndex}, ${sIndex})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Supprimer la leçon">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    subContainer.appendChild(subEl);
                });

                // Add Sub Button
                const addSubBtn = document.createElement('button');
                addSubBtn.onclick = () => addSubChapter(cIndex);
                addSubBtn.className = 'w-full py-3 border border-dashed border-gray-300 rounded-xl text-sm font-medium text-gray-500 hover:text-indigo-600 hover:border-indigo-300 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2 group';
                addSubBtn.innerHTML = '<i data-lucide="plus" class="w-4 h-4 group-hover:scale-110 transition-transform"></i> Ajouter une leçon';

                subContainer.appendChild(addSubBtn);
                chapEl.appendChild(subContainer);
                container.appendChild(chapEl);
            });

            lucide.createIcons();
        }

        // --- Actions ---
        function addNewChapter() {
            chapters.push({ id: Date.now(), title: '', pdf: null, subChapters: [] });
            renderChapters();
        }

        function removeChapter(idx) {
            chapters.splice(idx, 1);
            renderChapters();
        }

        function updateChapterTitle(idx, val) { chapters[idx].title = val; }

        function addSubChapter(cIdx) {
            chapters[cIdx].subChapters.push({ id: Date.now(), title: '', pdf: null, quiz: null });
            renderChapters();
        }

        function removeSubChapter(cIdx, sIdx) {
            chapters[cIdx].subChapters.splice(sIdx, 1);
            renderChapters();
        }

        function updateSubTitle(cIdx, sIdx, val) { chapters[cIdx].subChapters[sIdx].title = val; }

        // --- PDF Handling ---
        function handleChapterPdf(cIdx, input) {
            if (input.files && input.files[0]) {
                chapters[cIdx].pdf = input.files[0].name;
                renderChapters();
            }
        }
        function removeChapterPdf(cIdx) {
            chapters[cIdx].pdf = null;
            renderChapters();
        }
        function handleSubPdf(cIdx, sIdx, input) {
            if (input.files && input.files[0]) {
                chapters[cIdx].subChapters[sIdx].pdf = input.files[0].name;
                renderChapters();
            }
        }
        function removeSubPdf(cIdx, sIdx) {
            chapters[cIdx].subChapters[sIdx].pdf = null;
            renderChapters();
        }

        // --- Quiz Modal Logic ---
        function openQuizEditor(cIdx, sIdx) {
            const quiz = chapters[cIdx].subChapters[sIdx].quiz || {
                id: Date.now(),
                questions: []
            };

            editingQuizState = { chapterIndex: cIdx, subIndex: sIdx, currentQuiz: JSON.parse(JSON.stringify(quiz)) };

            document.getElementById('quiz-modal').classList.remove('hidden');
            renderQuizQuestions();
        }

        function closeQuizModal() {
            document.getElementById('quiz-modal').classList.add('hidden');
        }

        function renderQuizQuestions() {
            const list = document.getElementById('quiz-questions-list');
            list.innerHTML = '';

            if (editingQuizState.currentQuiz.questions.length === 0) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mb-3 text-gray-300"></i>
                        <p class="font-medium">Aucune question ajoutée</p>
                        <p class="text-xs">Commencez par ajouter une nouvelle question</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            editingQuizState.currentQuiz.questions.forEach((q, qIdx) => {
                const qEl = document.createElement('div');
                qEl.className = 'bg-white p-5 rounded-xl border border-gray-200 mb-4 shadow-sm relative group hover:border-indigo-100 transition-colors';
                qEl.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                            Question ${qIdx + 1}
                        </span>
                        <button onclick="removeQuestion(${qIdx})" class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <input type="text" value="${q.text}" onchange="updateQuestionText(${qIdx}, this.value)" 
                        placeholder="Écrivez votre question ici..." class="w-full p-3 border border-gray-200 rounded-lg mb-4 text-sm font-semibold text-gray-900 focus:ring-2 focus:ring-indigo-500 outline-none">
                    
                    <div class="space-y-2 pl-4 border-l-2 border-gray-100">
                        ${[0, 1, 2, 3].map(i => `
                            <div class="flex items-center gap-3 group/option">
                                <div class="relative flex items-center">
                                    <input type="radio" name="correct-${qIdx}" ${q.correctOptionIndex === i ? 'checked' : ''} 
                                        onchange="setCorrectOption(${qIdx}, ${i})" class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 cursor-pointer">
                                </div>
                                <input type="text" value="${q.options[i] || ''}" onchange="updateOption(${qIdx}, ${i}, this.value)"
                                    placeholder="Option ${i + 1}" class="flex-1 p-2 bg-transparent border-b border-transparent hover:border-gray-200 focus:border-indigo-500 outline-none text-sm transition-colors">
                                ${q.correctOptionIndex === i ? '<span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded ml-2">Correcte</span>' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(qEl);
            });
            lucide.createIcons();
        }

        function addQuestion() {
            editingQuizState.currentQuiz.questions.push({
                text: '',
                options: ['', '', '', ''],
                correctOptionIndex: 0
            });
            renderQuizQuestions();
        }

        function removeQuestion(qIdx) {
            editingQuizState.currentQuiz.questions.splice(qIdx, 1);
            renderQuizQuestions();
        }

        function updateQuestionText(qIdx, val) { editingQuizState.currentQuiz.questions[qIdx].text = val; }
        function updateOption(qIdx, oIdx, val) { editingQuizState.currentQuiz.questions[qIdx].options[oIdx] = val; }
        function setCorrectOption(qIdx, oIdx) {
            editingQuizState.currentQuiz.questions[qIdx].correctOptionIndex = oIdx;
            renderQuizQuestions(); // Re-render to show "Correcte" badge
        }

        function saveQuiz() {
            const { chapterIndex, subIndex, currentQuiz } = editingQuizState;
            chapters[chapterIndex].subChapters[subIndex].quiz = currentQuiz;
            renderChapters();
            closeQuizModal();
        }

        // --- Final Step ---
        function updateSummary() {
            const title = document.getElementById('course-title').value || 'Sans titre';
            document.getElementById('summary-text').textContent = `Le cours "${title}" est prêt à être publié.`;

            let totalLessons = 0;
            let totalPDFs = 0;
            let totalQuizzes = 0;

            chapters.forEach(c => {
                if (c.pdf) totalPDFs++;
                c.subChapters.forEach(s => {
                    totalLessons++;
                    if (s.pdf) totalPDFs++;
                    if (s.quiz && s.quiz.questions.length > 0) totalQuizzes++;
                });
            });

            document.getElementById('summary-details').innerHTML = `
                <div class="px-4 py-2 bg-white rounded-xl text-sm font-bold text-gray-700 border border-gray-200 shadow-sm flex items-center gap-2">
                    <i data-lucide="layers" class="w-4 h-4 text-gray-400"></i> ${chapters.length} Chapitres
                </div>
                <div class="px-4 py-2 bg-white rounded-xl text-sm font-bold text-gray-700 border border-gray-200 shadow-sm flex items-center gap-2">
                    <i data-lucide="book-open" class="w-4 h-4 text-gray-400"></i> ${totalLessons} Leçons
                </div>
                ${totalPDFs > 0 ? `
                    <div class="px-4 py-2 bg-green-50 rounded-xl text-sm font-bold text-green-700 border border-green-100 flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4 text-green-500"></i> ${totalPDFs} PDFs
                    </div>
                ` : ''}
                ${totalQuizzes > 0 ? `
                    <div class="px-4 py-2 bg-purple-50 rounded-xl text-sm font-bold text-purple-700 border border-purple-100 flex items-center gap-2">
                        <i data-lucide="help-circle" class="w-4 h-4 text-purple-500"></i> ${totalQuizzes} Quiz
                    </div>
                ` : ''}
            `;

            // Classes
            const classes = DataManager.getClasses();
            const container = document.getElementById('classes-select');

            if (classes.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-400 italic p-2">Aucune classe disponible.</div>';
                return;
            }

            container.innerHTML = classes.map(c => `
                <label class="flex items-center p-4 bg-white border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-blue-200 transition-all group">
                    <div class="relative flex items-center">
                        <input type="checkbox" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" value="${c.id}">
                    </div>
                    <div class="ml-4">
                        <div class="font-bold text-sm text-gray-900 group-hover:text-blue-700 transition-colors">${c.name}</div>
                        <div class="text-xs text-gray-500">${c.students} élèves • ${c.level}</div>
                    </div>
                </label>
            `).join('');
        }

        function finishCreation() {
            const title = document.getElementById('course-title').value;
            if (!title) {
                alert('Veuillez donner un titre au cours');
                return;
            }

            const course = {
                title: title,
                level: '1ère Année',
                chaptersData: chapters,
                status: 'published',
                createdAt: new Date().toISOString()
            };

            DataManager.saveCourse(course);
            // Show toast or alert then redirect
            const btn = document.querySelector('button[onclick="finishCreation()"]');
            btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i> Publication...';

            setTimeout(() => {
                window.location.href = 'mediatheque.html';
            }, 1000);
        }
    </script>
</body>

</html>