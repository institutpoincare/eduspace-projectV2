<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Création Contenu Enregistré - EduSpace Formateur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blue: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        gray: { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 500: '#6b7280', 700: '#374151', 900: '#111827' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="../../css/main.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .step-item.active .step-number {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .step-item.completed .step-number {
            background-color: #22c55e;
            color: white;
            border-color: #22c55e;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .recording-pulse {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Preview Card Styles */
        .preview-card {
            transition: all 0.3s ease;
        }

        .preview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 overflow-x-hidden">
    <div class="flex min-h-screen relative">
        <div id="sidebar-container" class="fixed top-0 left-0 h-full w-[280px] z-30 transition-transform duration-300">
        </div>

        <!-- Studio Modal -->
        <div id="studio-modal" class="fixed inset-0 z-50 bg-gray-900 hidden flex flex-col">
            <div class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center text-white">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center shadow-lg"><i
                            data-lucide="video" class="text-white"></i></div>
                    <div>
                        <h1 class="font-bold text-lg">Studio d'Enregistrement</h1>
                        <p class="text-xs text-gray-400" id="studio-lesson-title">Leçon: Introduction</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="timer-display" class="font-mono text-xl font-bold text-red-500 hidden">00:00:00</div>
                    <button onclick="closeStudio()" class="p-2 hover:bg-gray-700 rounded-full"><i data-lucide="x"
                            class="w-6 h-6"></i></button>
                </div>
            </div>
            <div class="flex-1 flex bg-gray-900 relative">
                <div class="flex-1 flex items-center justify-center bg-black relative">
                    <div id="video-placeholder" class="text-gray-500 flex flex-col items-center"><i
                            data-lucide="camera-off" class="w-16 h-16 mb-4 opacity-50"></i>
                        <p>Camera Preview</p>
                    </div>
                    <canvas id="whiteboard"
                        class="absolute inset-0 w-full h-full cursor-crosshair hidden bg-white"></canvas>
                </div>
                <div class="w-20 bg-gray-800 border-l border-gray-700 flex flex-col items-center py-6 gap-4">
                    <button onclick="toggleWhiteboard()"
                        class="p-3 bg-gray-700 rounded-xl hover:bg-blue-600 transition-colors text-white"
                        title="Tableau Blanc"><i data-lucide="pen-tool"></i></button>
                </div>
            </div>
            <div class="bg-gray-800 px-6 py-4 flex justify-center items-center gap-8 border-t border-gray-700">
                <button id="record-btn" onclick="toggleRecord()"
                    class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center hover:bg-red-700 transition-all shadow-lg hover:scale-105 border-4 border-gray-800 focus:outline-none">
                    <div class="w-6 h-6 bg-white rounded-sm" style="display:none" id="stop-icon"></div>
                    <div class="w-6 h-6 bg-white rounded-full" id="rec-icon"></div>
                </button>
            </div>
        </div>

        <main id="main-content" class="flex-1 p-6 ml-[280px] min-h-screen flex flex-col transition-all duration-300">
            <header class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-4">
                    <button onclick="document.body.classList.toggle('sidebar-hidden')"
                        class="p-2 hover:bg-gray-200 rounded-lg text-gray-600 transition-colors"><i data-lucide="menu"
                            class="w-6 h-6"></i></button>
                    <h1 class="text-2xl font-bold text-gray-900">Nouveau Cours Enregistré</h1>
                </div>
            </header>

            <div class="max-w-6xl mx-auto w-full">
                <!-- Steps -->
                <div class="flex justify-between relative mb-12 max-w-3xl mx-auto">
                    <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-gray-200 -z-10 -translate-y-1/2"></div>
                    <div class="step-item active flex flex-col items-center gap-2 bg-gray-50 px-4 z-10" id="step-ind-1">
                        <div
                            class="step-number w-10 h-10 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center font-bold text-gray-500 transition-colors">
                            1</div>
                        <span class="text-xs font-bold text-gray-500">Infos</span>
                    </div>
                    <div class="step-item flex flex-col items-center gap-2 bg-gray-50 px-4 z-10" id="step-ind-2">
                        <div
                            class="step-number w-10 h-10 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center font-bold text-gray-500 transition-colors">
                            2</div>
                        <span class="text-xs font-bold text-gray-500">Contenu</span>
                    </div>
                    <div class="step-item flex flex-col items-center gap-2 bg-gray-50 px-4 z-10" id="step-ind-3">
                        <div
                            class="step-number w-10 h-10 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center font-bold text-gray-500 transition-colors">
                            3</div>
                        <span class="text-xs font-bold text-gray-500">Publication</span>
                    </div>
                </div>

                <form id="course-form" onsubmit="return false;">
                    <!-- Step 1: Info -->
                    <div class="form-section active" id="step-1">
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 max-w-3xl mx-auto">
                            <h2 class="text-xl font-bold mb-6 text-gray-900">Détails du Cours</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Titre du cours</label>
                                    <input type="text" id="course-title" oninput="updatePreview()"
                                        class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="Ex: Masterclass Python">
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Catégorie</label>
                                        <select id="course-cat" onchange="updatePreview()"
                                            class="w-full p-4 border border-gray-200 rounded-xl outline-none bg-white">
                                            <option value="Scolaire">Scolaire</option>
                                            <option value="Formation">Formation Pro</option>
                                            <option value="Universitaire">Universitaire</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Niveau</label>
                                        <select id="course-lvl" onchange="updatePreview()"
                                            class="w-full p-4 border border-gray-200 rounded-xl outline-none bg-white">
                                            <option value="Débutant">Débutant</option>
                                            <option value="Intermédiaire">Intermédiaire</option>
                                            <option value="Avancé">Avancé</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end">
                                <button onclick="nextStep(2)"
                                    class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg">Suivant</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Content -->
                    <div class="form-section" id="step-2">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">Contenu & Enregistrement</h2>
                            <button onclick="addNewChapter()"
                                class="flex items-center px-4 py-2 bg-gray-900 text-white rounded-xl font-bold shadow-lg"><i
                                    data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Chapitre</button>
                        </div>
                        <div id="chapters-container" class="space-y-6 mb-8"></div>
                        <div class="flex justify-between items-center">
                            <button onclick="nextStep(1)"
                                class="px-6 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-xl">Retour</button>
                            <button onclick="nextStep(3)"
                                class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Suivant</button>
                        </div>
                    </div>

                    <!-- Step 3: Publication & Marketing -->
                    <div class="form-section" id="step-3">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">

                            <!-- Left: Sale Settings -->
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                                <h2 class="text-xl font-bold mb-6 text-gray-900">Paramètres de Vente</h2>

                                <!-- Cover Image -->
                                <div class="mb-6">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Photo de
                                        Couverture</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-500 transition-colors cursor-pointer group relative overflow-hidden"
                                        onclick="document.getElementById('cover-upload').click()">
                                        <input type="file" id="cover-upload" class="hidden" accept="image/*"
                                            onchange="handleCoverUpload(this)">
                                        <div id="cover-placeholder">
                                            <i data-lucide="image"
                                                class="w-10 h-10 text-gray-300 mx-auto mb-2 group-hover:text-blue-500"></i>
                                            <p class="text-sm text-gray-500">Cliquer pour uploader (Fond blanc
                                                recommandé)</p>
                                        </div>
                                        <img id="cover-preview-img" src=""
                                            class="absolute inset-0 w-full h-full object-cover hidden">
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="mb-6">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Description &
                                        Démonstration</label>
                                    <textarea id="course-desc" rows="4" oninput="updatePreview()"
                                        class="w-full p-4 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Décrivez votre cours... Pourquoi les élèves devraient-ils l'acheter ?"></textarea>
                                </div>

                                <!-- Pricing -->
                                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <span class="font-bold text-gray-700">Prix du Cours</span>
                                        <label class="flex items-center cursor-pointer">
                                            <span class="mr-2 text-sm text-gray-600 font-medium">Gratuit</span>
                                            <input type="checkbox" id="is-free"
                                                onchange="togglePrice(); updatePreview()" class="sr-only peer">
                                            <div
                                                class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                            </div>
                                        </label>
                                    </div>

                                    <div id="price-fields">
                                        <div class="mb-4">
                                            <label class="text-xs font-bold text-gray-500 uppercase">Prix Standard
                                                (TND)</label>
                                            <input type="number" id="course-price" value="49" oninput="updatePreview()"
                                                class="w-full p-3 border border-gray-300 rounded-lg mt-1 font-bold text-gray-900 outline-none">
                                        </div>

                                        <div class="flex items-center justify-between mb-2">
                                            <label class="flex items-center cursor-pointer">
                                                <input type="checkbox" id="has-discount"
                                                    onchange="toggleDiscount(); updatePreview()"
                                                    class="w-4 h-4 text-blue-600 rounded">
                                                <span class="ml-2 text-sm font-bold text-gray-600">Activer
                                                    Promotion</span>
                                            </label>
                                        </div>

                                        <div id="discount-field" class="hidden animate-[fadeIn_0.2s]">
                                            <label class="text-xs font-bold text-gray-500 uppercase">Prix Promo
                                                (TND)</label>
                                            <input type="number" id="course-discount-price" value="29"
                                                oninput="updatePreview()"
                                                class="w-full p-3 border border-red-300 rounded-lg mt-1 font-bold text-red-600 outline-none bg-red-50">
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center pt-4">
                                    <button onclick="nextStep(2)"
                                        class="px-6 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-xl">Retour</button>
                                    <button onclick="finishCreation()"
                                        class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg shadow-green-900/20 transition-all hover:-translate-y-1">
                                        Publier Le Cours
                                    </button>
                                </div>
                            </div>

                            <!-- Right: Student Preview -->
                            <div
                                class="bg-gray-100 p-8 rounded-2xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center relative">
                                <span
                                    class="absolute top-4 right-4 text-xs font-bold text-gray-400 uppercase tracking-widest bg-white px-2 py-1 rounded">Aperçu
                                    Étudiant</span>

                                <!-- Preview Card Component -->
                                <div
                                    class="preview-card bg-white rounded-2xl shadow-xl overflow-hidden w-full max-w-sm border border-gray-100">
                                    <!-- Image -->
                                    <div class="h-48 bg-gray-200 relative overflow-hidden group">
                                        <img id="preview-image"
                                            src="https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=800"
                                            class="w-full h-full object-cover transition-transform group-hover:scale-105">
                                        <div class="absolute top-3 left-3 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-blue-600"
                                            id="preview-cat">
                                            Formation
                                        </div>
                                        <div
                                            class="absolute bottom-3 right-3 bg-black/70 text-white px-2 py-1 rounded-md text-xs font-bold flex items-center gap-1">
                                            <i data-lucide="video" class="w-3 h-3"></i> <span id="preview-duration">0h
                                                0m</span>
                                        </div>
                                    </div>

                                    <!-- Content -->
                                    <div class="p-5">
                                        <div class="flex justify-between items-start mb-2">
                                            <h3 class="font-bold text-lg text-gray-900 leading-tight line-clamp-2"
                                                id="preview-title">Nouveau Cours</h3>
                                            <div
                                                class="flex items-center gap-1 text-yellow-400 text-xs font-bold bg-yellow-50 px-2 py-1 rounded-full">
                                                <span>★</span> 5.0
                                            </div>
                                        </div>

                                        <p class="text-sm text-gray-500 line-clamp-2 mb-4 h-10" id="preview-desc">
                                            Description du cours...</p>

                                        <div
                                            class="flex items-center justify-between mt-auto pt-4 border-t border-gray-50">
                                            <div class="flex items-center gap-2">
                                                <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden">
                                                    <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?w=100"
                                                        class="w-full h-full object-cover">
                                                </div>
                                                <div class="text-xs">
                                                    <p class="font-bold text-gray-900">Moi</p>
                                                    <p class="text-gray-400">Formateur</p>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div id="preview-price-container">
                                                    <span class="text-lg font-bold text-blue-600" id="preview-price">49
                                                        TND</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="mt-4 text-xs text-gray-400 text-center max-w-xs">Voici comment votre cours
                                    apparaîtra dans le catalogue pour les élèves.</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../../js/core/data-manager.js"></script>
    <script src="../../js/components/sidebar-formateur.js?v=2"></script>
    <script>
        // --- State ---
        let chapters = [{ id: Date.now(), title: '', subChapters: [] }];
        let isRecording = false;
        let coverImageDefault = "https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=800&auto=format&fit=crop&q=60";
        let coverImage = coverImageDefault;

        document.addEventListener('DOMContentLoaded', async () => {
            if (window.dataManager) await dataManager.init();
            lucide.createIcons();
            renderChapters();
            updatePreview();
        });

        // --- Navigation & Sidebar ---
        function toggleSidebar() { document.body.classList.toggle('sidebar-hidden'); }
        function nextStep(step) {
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            for (let i = 1; i <= step; i++) {
                const el = document.getElementById(`step-ind-${i}`);
                if (i === step) el.classList.add('active');
                else if (i < step) { el.classList.remove('active'); el.classList.add('completed'); document.querySelector(`#step-ind-${i} .step-number`).innerText = '✓'; }
                else { el.classList.remove('active', 'completed'); document.querySelector(`#step-ind-${i} .step-number`).innerText = i; }
            }
            if (step === 3) updatePreview();
            lucide.createIcons();
        }

        // --- Content Logic (Simplified for brevity) ---
        function renderChapters() {
            const container = document.getElementById('chapters-container');
            container.innerHTML = chapters.map((c, i) => `
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b border-gray-100 flex items-center gap-3">
                        <span class="font-bold text-gray-500">Ch. ${i + 1}</span>
                        <input type="text" value="${c.title}" oninput="chapters[${i}].title=this.value" class="flex-1 bg-transparent font-bold outline-none" placeholder="Titre chapitre">
                        <button onclick="addChapter()" class="text-blue-600 hover:text-blue-700 text-sm font-bold">+ Chapitre</button>
                    </div>
                </div>
             `).join('');
            if (chapters.length === 0) container.innerHTML = `<button onclick="addChapter()" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl font-bold text-gray-400 hover:border-blue-500 hover:text-blue-600">Ajouter le premier chapitre</button>`;
        }
        function addChapter() { chapters.push({ id: Date.now(), title: '', subChapters: [] }); renderChapters(); }
        function addNewChapter() { addChapter(); } // Alias for button

        // --- PREVIEW & MARKETING LOGIC ---
        function handleCoverUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    coverImage = e.target.result;
                    document.getElementById('cover-preview-img').src = coverImage;
                    document.getElementById('cover-preview-img').classList.remove('hidden');
                    document.getElementById('cover-placeholder').classList.add('hidden');
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function togglePrice() {
            const isFree = document.getElementById('is-free').checked;
            document.getElementById('price-fields').classList.toggle('opacity-50', isFree);
            document.getElementById('course-price').disabled = isFree;
            document.getElementById('course-discount-price').disabled = isFree;
        }

        function toggleDiscount() {
            const hasDisc = document.getElementById('has-discount').checked;
            const el = document.getElementById('discount-field');
            if (hasDisc) el.classList.remove('hidden'); else el.classList.add('hidden');
        }

        function updatePreview() {
            // Get Values
            const title = document.getElementById('course-title').value || "Titre du Cours";
            const cat = document.getElementById('course-cat').value;
            const desc = document.getElementById('course-desc').value || "Description courte du cours pour donner envie aux étudiants...";
            const isFree = document.getElementById('is-free').checked;
            const price = parseFloat(document.getElementById('course-price').value) || 0;
            const hasDiscount = document.getElementById('has-discount').checked;
            const discountPrice = parseFloat(document.getElementById('course-discount-price').value) || 0;

            // Compute Duration (Mock)
            const duration = "2h 15m";

            // Update DOM
            document.getElementById('preview-title').innerText = title;
            document.getElementById('preview-cat').innerText = cat;
            document.getElementById('preview-desc').innerText = desc;
            document.getElementById('preview-image').src = coverImage;
            document.getElementById('preview-duration').innerText = duration;

            // Price Formatting
            const priceContainer = document.getElementById('preview-price-container');
            if (isFree) {
                priceContainer.innerHTML = `<span class="text-xl font-bold text-green-600">Gratuit</span>`;
            } else {
                if (hasDiscount && discountPrice < price) {
                    priceContainer.innerHTML = `
                        <div class="flex flex-col items-end leading-none">
                            <span class="text-xs text-gray-400 line-through font-medium">${price} TND</span>
                            <span class="text-xl font-bold text-red-600">${discountPrice} TND</span>
                        </div>
                    `;
                } else {
                    priceContainer.innerHTML = `<span class="text-xl font-bold text-blue-600">${price} TND</span>`;
                }
            }
        }

        // --- SUBMIT ---
        async function finishCreation() {
            const btn = document.querySelector('button[onclick="finishCreation()"]');
            btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i> Publication...';

            const courseData = {
                id: 'rec_' + Date.now(),
                title: document.getElementById('course-title').value,
                category: document.getElementById('course-cat').value,
                level: document.getElementById('course-lvl').value,
                description: document.getElementById('course-desc').value,
                image: coverImage,
                isFree: document.getElementById('is-free').checked,
                price: parseFloat(document.getElementById('course-price').value) || 0,
                discountPrice: document.getElementById('has-discount').checked ? parseFloat(document.getElementById('course-discount-price').value) : null,
                chapters: chapters,
                status: 'published',
                type: 'recorded',
                createdAt: new Date().toISOString()
            };

            if (window.dataManager) {
                await dataManager.create('courses', courseData); // Or 'recorded_courses' if separate schema
            }

            // Simulate delay then redirect
            setTimeout(() => {
                window.location.href = 'mediatheque.html';
            }, 1000);
        }
    </script>
</body>

</html>